#!/bin/bash
# üé¨ YouTube Tools - Unified interface for all YouTube operations
# =========================================================

# Configuration
PKM_BASE="/Users/user/____Sandruk/___PKM/_Outputs_External/youtube"
YOUTUBE_ANALYZER="/Users/user/__Repositories/youtube-scrapping/youtube_channel_analyzer"
PYTHON_SCRIPT="$YOUTUBE_ANALYZER/src/main.py"
TEMP_CSV="/tmp/yt_temp_$$.csv"

# Ensure base directory exists
mkdir -p "$PKM_BASE"

# Function to detect input type and normalize
normalize_input() {
    local input=$1
    
    # Direct video URL
    if [[ $input =~ youtube\.com/watch\?v=([a-zA-Z0-9_-]{11}) ]] || [[ $input =~ youtu\.be/([a-zA-Z0-9_-]{11}) ]]; then
        echo "video:${BASH_REMATCH[1]}"
        return
    fi
    
    # Playlist URL
    if [[ $input =~ [\?\&]list=([^\&]+) ]]; then
        echo "playlist:${BASH_REMATCH[1]}"
        return
    fi
    
    # Channel formats
    if [[ $input =~ youtube\.com/@([^/]+) ]]; then
        echo "channel:@${BASH_REMATCH[1]}"
    elif [[ $input =~ youtube\.com/c/([^/]+) ]]; then
        echo "channel:c/${BASH_REMATCH[1]}"
    elif [[ $input =~ youtube\.com/channel/([^/]+) ]]; then
        echo "channel:channel/${BASH_REMATCH[1]}"
    elif [[ $input =~ ^UC[a-zA-Z0-9_-]{22}$ ]]; then
        echo "channel:channel/$input"
    elif [[ $input =~ ^@[a-zA-Z0-9_-]+$ ]]; then
        echo "channel:$input"
    else
        echo "channel:@$input"  # Assume it's a username
    fi
}

# Function to get channel name for directory creation
get_channel_name() {
    local input=$1
    local type=$(echo "$input" | cut -d: -f1)
    local value=$(echo "$input" | cut -d: -f2)
    
    case $type in
        channel)
            if [[ $value =~ ^@ ]]; then
                echo "${value#@}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9_-]/_/g'
            else
                # For channel IDs, try to fetch actual name
                local name=$(yt-dlp --print "%(channel)s" "https://youtube.com/$value" 2>/dev/null | head -1)
                if [ -n "$name" ]; then
                    echo "$name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9_-]/_/g'
                else
                    echo "${value##*/}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9_-]/_/g'
                fi
            fi
            ;;
        playlist)
            echo "$value" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9_-]/_/g'
            ;;
        video)
            echo "single_video"
            ;;
    esac
}

# Function to create temporary CSV for Python script
create_temp_csv() {
    local name=$1
    local id=$2
    echo "Channel Name,Channel ID" > "$TEMP_CSV"
    echo "$name,$id" >> "$TEMP_CSV"
}

# Clean up on exit
cleanup() {
    rm -f "$TEMP_CSV"
}
trap cleanup EXIT

# Main function
case "$1" in
    playlists)
        # List all playlists from a channel
        if [ -z "$2" ]; then
            echo "Usage: $0 playlists <channel_url|@username|channel_id>"
            exit 1
        fi
        
        normalized=$(normalize_input "$2")
        type=$(echo "$normalized" | cut -d: -f1)
        value=$(echo "$normalized" | cut -d: -f2)
        
        if [ "$type" != "channel" ]; then
            echo "Error: Please provide a channel URL, @username, or channel ID"
            exit 1
        fi
        
        channel_name=$(get_channel_name "$normalized")
        channel_url="https://youtube.com/$value"
        
        echo "üìã Fetching playlists for channel: $channel_name"
        
        # Create temp CSV and run Python script
        create_temp_csv "$channel_name" "$channel_url"
        
        cd "$YOUTUBE_ANALYZER" || exit 1
        python "$PYTHON_SCRIPT" \
            --input-file "$TEMP_CSV" \
            --actions listPlaylists \
            --output-dir "$PKM_BASE/youtube-playlists"
        
        # Copy to organized location
        if [ -f "$PKM_BASE/youtube-playlists/$channel_name/${channel_name}_playlists.csv" ]; then
            cp "$PKM_BASE/youtube-playlists/$channel_name/${channel_name}_playlists.csv" \
               "$PKM_BASE/youtube-playlists/${channel_name}_playlists_$(date +%Y%m%d).csv"
            echo "‚úÖ Playlists saved to: $PKM_BASE/youtube-playlists/${channel_name}_playlists_$(date +%Y%m%d).csv"
        fi
        ;;
        
    subsplaylist)
        # Download subtitles for a playlist
        if [ -z "$2" ]; then
            echo "Usage: $0 subsplaylist <playlist_url|playlist_id> [language]"
            exit 1
        fi
        
        lang=${3:-en}
        normalized=$(normalize_input "$2")
        type=$(echo "$normalized" | cut -d: -f1)
        value=$(echo "$normalized" | cut -d: -f2)
        
        if [ "$type" = "playlist" ]; then
            playlist_url="https://youtube.com/playlist?list=$value"
        else
            playlist_url="$2"
        fi
        
        echo "üìù Downloading subtitles for playlist in language: $lang"
        
        # Create playlist-specific directory
        playlist_dir="$PKM_BASE/subtitles-youtube/playlists/$value"
        mkdir -p "$playlist_dir"
        
        # Download subtitles using yt-dlp directly
        yt-dlp --skip-download \
            --write-sub --write-auto-sub \
            --sub-langs "$lang" \
            --sub-format "vtt/srt/best" \
            -o "$playlist_dir/%(upload_date)s-%(title)s__%(id)s.%(ext)s" \
            --restrict-filenames \
            "$playlist_url"
        
        echo "‚úÖ Subtitles saved to: $playlist_dir"
        ;;
        
    subsall)
        # Download all subtitles from a channel
        if [ -z "$2" ]; then
            echo "Usage: $0 subsall <channel_url|@username|channel_id> [language]"
            exit 1
        fi
        
        lang=${3:-en}
        normalized=$(normalize_input "$2")
        type=$(echo "$normalized" | cut -d: -f1)
        value=$(echo "$normalized" | cut -d: -f2)
        
        if [ "$type" != "channel" ]; then
            echo "Error: Please provide a channel URL, @username, or channel ID"
            exit 1
        fi
        
        channel_name=$(get_channel_name "$normalized")
        channel_url="https://youtube.com/$value"
        
        echo "üìö Downloading all subtitles from channel: $channel_name"
        
        # First get playlists
        echo "Step 1: Fetching playlists..."
        $0 playlists "$2"
        
        # Create channel directory
        channel_dir="$PKM_BASE/subtitles-youtube/channels/$channel_name"
        mkdir -p "$channel_dir/no-playlist"
        
        # Read playlists if they exist
        playlist_file="$PKM_BASE/youtube-playlists/${channel_name}_playlists_$(date +%Y%m%d).csv"
        if [ -f "$playlist_file" ]; then
            echo "Step 2: Downloading subtitles from playlists..."
            tail -n +2 "$playlist_file" | while IFS=, read -r playlist_id playlist_title; do
                playlist_id=$(echo "$playlist_id" | tr -d '"' | xargs)
                playlist_title=$(echo "$playlist_title" | tr -d '"' | xargs | tr ' ' '_' | tr '[:upper:]' '[:lower:]')
                
                echo "  üìÅ Processing playlist: $playlist_title"
                playlist_dir="$channel_dir/$playlist_title"
                mkdir -p "$playlist_dir"
                
                yt-dlp --skip-download \
                    --write-sub --write-auto-sub \
                    --sub-langs "$lang" \
                    --sub-format "vtt/srt/best" \
                    -o "$playlist_dir/%(upload_date)s-%(title)s__%(id)s.%(ext)s" \
                    --restrict-filenames \
                    "https://youtube.com/playlist?list=$playlist_id"
            done
        fi
        
        # Get videos not in playlists
        echo "Step 3: Downloading subtitles from videos not in playlists..."
        yt-dlp --skip-download \
            --write-sub --write-auto-sub \
            --sub-langs "$lang" \
            --sub-format "vtt/srt/best" \
            -o "$channel_dir/no-playlist/%(upload_date)s-%(title)s__%(id)s.%(ext)s" \
            --restrict-filenames \
            --match-filter "playlist_title is None" \
            "$channel_url/videos"
        
        echo "‚úÖ All subtitles saved to: $channel_dir"
        ;;
        
    videosplaylist)
        # List videos in a playlist
        if [ -z "$2" ]; then
            echo "Usage: $0 videosplaylist <playlist_url|playlist_id>"
            exit 1
        fi
        
        normalized=$(normalize_input "$2")
        type=$(echo "$normalized" | cut -d: -f1)
        value=$(echo "$normalized" | cut -d: -f2)
        
        if [ "$type" = "playlist" ]; then
            playlist_url="https://youtube.com/playlist?list=$value"
        else
            playlist_url="$2"
        fi
        
        echo "üìπ Listing videos in playlist..."
        
        output_file="$PKM_BASE/youtube-videos/playlist_${value}_videos_$(date +%Y%m%d).csv"
        
        # Get video list with metadata
        yt-dlp --flat-playlist \
            --print "%(id)s,%(title)s,%(duration)s,%(upload_date)s,%(view_count)s" \
            "$playlist_url" > "$output_file"
        
        # Add header
        sed -i '1i\Video ID,Title,Duration,Upload Date,View Count' "$output_file"
        
        echo "‚úÖ Video list saved to: $output_file"
        ;;
        
    videosall)
        # List all videos from a channel
        if [ -z "$2" ]; then
            echo "Usage: $0 videosall <channel_url|@username|channel_id>"
            exit 1
        fi
        
        normalized=$(normalize_input "$2")
        type=$(echo "$normalized" | cut -d: -f1)
        value=$(echo "$normalized" | cut -d: -f2)
        
        if [ "$type" != "channel" ]; then
            echo "Error: Please provide a channel URL, @username, or channel ID"
            exit 1
        fi
        
        channel_name=$(get_channel_name "$normalized")
        channel_url="https://youtube.com/$value"
        
        echo "üé¨ Listing all videos from channel: $channel_name"
        
        output_file="$PKM_BASE/youtube-videos/${channel_name}_all_videos_$(date +%Y%m%d).csv"
        
        # Get comprehensive video list
        yt-dlp --flat-playlist \
            --print "%(id)s,%(title)s,%(duration)s,%(upload_date)s,%(view_count)s,%(playlist_title)s,%(playlist_id)s" \
            "$channel_url/videos" > "$output_file"
        
        # Add header
        sed -i '1i\Video ID,Title,Duration,Upload Date,View Count,Playlist Title,Playlist ID' "$output_file"
        
        echo "‚úÖ Video list saved to: $output_file"
        ;;
        
    downloadmin)
        # Minimal video download for transcription
        if [ -z "$2" ]; then
            echo "Usage: $0 downloadmin <video_url|video_id> [quality]"
            echo "Quality options: 144p, 240p, 360p, 480p (default), 720p"
            exit 1
        fi
        
        quality=${3:-480p}
        normalized=$(normalize_input "$2")
        type=$(echo "$normalized" | cut -d: -f1)
        value=$(echo "$normalized" | cut -d: -f2)
        
        if [ "$type" = "video" ]; then
            video_url="https://youtube.com/watch?v=$value"
        else
            video_url="$2"
        fi
        
        echo "‚¨áÔ∏è Downloading video in $quality for transcription..."
        
        # Get video info first
        video_info=$(yt-dlp --print "%(title)s|%(upload_date)s|%(channel)s|%(id)s" "$video_url")
        IFS='|' read -r title upload_date channel video_id <<< "$video_info"
        
        # Sanitize for filename
        safe_title=$(echo "$title" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9_-]/_/g' | cut -c1-50)
        safe_channel=$(echo "$channel" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9_-]/_/g')
        
        output_dir="$PKM_BASE/youtube-downloads"
        output_file="$output_dir/${upload_date}-${safe_title}__by-${safe_channel}__${video_id}.mp4"
        
        # Download with specific quality
        yt-dlp -f "bestvideo[height<=${quality%p}]+bestaudio/best[height<=${quality%p}]" \
            --merge-output-format mp4 \
            -o "$output_file" \
            "$video_url"
        
        echo "‚úÖ Video saved to: $output_file"
        echo "üí° Tip: Use SuperWhisper or 'transcribe' alias to extract text"
        ;;
        
    *)
        echo "üé¨ YouTube Tools - Available commands:"
        echo ""
        echo "  $0 playlists <channel>      - List all playlists from channel"
        echo "  $0 subsplaylist <playlist>  - Download subtitles for playlist"
        echo "  $0 subsall <channel>        - Download all subtitles (organized by playlist)"
        echo "  $0 videosplaylist <playlist>- List videos in playlist"
        echo "  $0 videosall <channel>      - List all videos from channel"
        echo "  $0 downloadmin <video>      - Minimal download for transcription"
        echo ""
        echo "Input formats supported:"
        echo "  - Channel: @username, UCxxxxxx, youtube.com/@username"
        echo "  - Playlist: PLxxxxxx, youtube.com/playlist?list=PLxxxxxx"
        echo "  - Video: xxxxxxxxxxx, youtube.com/watch?v=xxxxxxxxxxx"
        ;;
esac