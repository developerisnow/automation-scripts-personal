# Filename Normalization Script Specification\n\nğŸ¨ğŸ¨ğŸ¨ **ENTERING CREATIVE PHASE: Architecture Design** ğŸ¨ğŸ¨ğŸ¨\n\n**Component Description:**\n\nThe `filename-normalization-script.py` is a command-line utility designed for macOS. Its purpose is to scan a specified directory containing exported chat files (initially focusing on ChatGPT exports) and perform two main actions:\n1.  **Rename files:** Standardize filenames, optionally adding a timestamp prefix.\n2.  **Clean content:** Remove embedded image data and specific watermarks from the file content.\n\nThe target format is `[<yyyy-mm-dd-hhmm>-]thread-llm-ChatGPT-<normalized-topic>.md`, where the timestamp prefix is optional.\n\n**Requirements & Constraints:**\n\n1.  **Core Functionality - Renaming:**\n    *   Scan a specified target directory for files needing normalization (e.g., `ChatGPT-*.md`).\n    *   Identify files that *do not* already conform to the target format (regex check, accounting for optional timestamp).\n    *   For each file needing renaming:\n        *   If timestamp addition is enabled (`--add-timestamp` flag): Extract the file\'s last modification timestamp and format as `yyyy-mm-dd-hhmm`.\n        *   Extract the original \"topic\" part of the filename.\n        *   Normalize the topic string (see rule 5).\n        *   Construct the new filename using the standard format (with or without timestamp prefix based on flag).\n        *   Rename the file within the same directory.\n2.  **Core Functionality - Content Cleaning:**\n    *   After potentially renaming, process the file\'s content.\n    *   Remove embedded base64 image data matching patterns like `![image](data:application...)`.\n    *   Remove specific watermark strings/characters like `îˆ€citeîˆ‚turn0search0îˆ`.\n    *   Overwrite the file *only* if content changes were made.\n3.  **Configuration:**\n    *   Target directory must be configurable (`--dir`, default: `/Users/user/____Sandruk/___PKM/_Outputs_AI/chatgpt-export-chats`).\n    *   Timestamp addition should be optional (`--add-timestamp`, boolean flag, default: False).\n    *   Log file path and level should be configurable (`--log-file`, `--log-level`).\n4.  **Timestamp Extraction (Optional):** Use file\'s last modification time (`os.path.getmtime`) if `--add-timestamp` is specified.\n5.  **Normalization Rules (`<normalized-topic>`):**\n    *   Extract topic after a prefix (e.g., `ChatGPT-`, case-insensitive).\n    *   Transliterate non-ASCII characters (Cyrillic) to lowercase Latin (`transliterate` library).\n    *   Convert the result to lowercase.\n    *   Replace sequences of whitespace with a single hyphen (`-`).\n    *   Replace problematic filename characters (`?`, `:`, `/`, `\\`, `|`, `*`, `<`, `>`, `\"`, `.`) with a hyphen (`-`).\n    *   Preserve existing underscores (`_`).\n    *   Replace multiple consecutive hyphens with a single hyphen.\n    *   Remove leading/trailing hyphens or underscores.\n    *   Ensure filesystem safety.\n6.  **File Handling:**\n    *   Rename files in place.\n    *   Handle potential filename collisions during rename (log error, skip).\n    *   The script should be idempotent (multiple runs don't re-process/cause errors).\n    *   Handle file reading/writing errors during content cleaning (log error, potentially skip cleaning for that file).\n7.  **Logging:**\n    *   Use Python\'s `logging` module.\n    *   Log script start/end.\n    *   Log number of files scanned, considered for rename, and considered for cleaning.\n    *   Log each successful rename (old -> new).\n    *   Log content cleaning actions per file (e.g., number of images/watermarks removed).\n    *   Log skipped files (already formatted, collision, cleaning error).\n    *   Log errors (permissions, filesystem, normalization, cleaning).\n    *   Log summary statistics (total files renamed, total files cleaned, total images/watermarks removed across all files).\n8.  **Execution & Scheduling:**\n    *   Command-line executable.\n    *   Support periodic execution (hourly via `launchd`).\n    *   Support manual execution via shell alias (`name2standards`).\n9.  **User Interface:**\n    *   Command-line arguments (`--dir`, `--add-timestamp`, `--log-file`, `--log-level`, `--verbose`).\n    *   `--help` option.\n10. **Extensibility:** Design should allow adding support for other providers/formats.\n11. **Best Practices:** PEP 8, docstrings, type hinting, error handling, UTF-8 encoding for file I/O.\n12. **Dependencies:** `transliterate` library.\n\n**Multiple Options (Architecture Approaches):**\n\n1.  **Option 1: Simple Procedural Script:** Functions for each step.\n    *   *Pros:* Quickest dev time.\n    *   *Cons:* Becomes complex, hard to test/extend, mixes file operations and content manipulation.\n2.  **Option 2: Class-Based Structure:** `FilenameNormalizer` class with methods for scanning, checking, parsing, normalizing, renaming, and *content cleaning*.\n    *   *Pros:* Good organization, testable methods, reasonably extensible.\n    *   *Cons:* Class handles both filename and content logic.\n3.  **Option 3: Class-Based with Strategy/Dedicated Cleaner:** `FilenameNormalizer` handles naming. A separate `ContentCleaner` class (or strategy classes per provider) handles content modification.\n    *   *Pros:* Excellent separation of concerns (naming vs. content), highly testable and extensible.\n    *   *Cons:* More complex structure.\n\n**Options Analysis:**\n\n*   Option 1 is insufficient.\n*   Option 2 keeps related logic together but might slightly violate single responsibility principle as the class handles both filename *and* content.\n*   Option 3 offers the cleanest separation but adds structural overhead.\n\n**Recommended Approach:**\n\n**Option 2: Class-Based Structure.** Given the tight coupling (cleaning happens on the files identified for potential renaming), keeping it within the `FilenameNormalizer` class is acceptable for now. We will add a dedicated `_clean_file_content` method. If cleaning logic becomes significantly more complex or provider-specific, it can be refactored out later (aligns with progressive complexity). This balances structure and initial implementation effort.\n\n**Implementation Guidelines:**\n\n1.  **Project Structure:** `filename-normalization-script.py`, `filename_normalization.log`, `README.md`.\n2.  **Main Script:** Imports, defaults, `setup_logging`, `main` (argparse, instantiate `FilenameNormalizer`, run).\n3.  **`FilenameNormalizer` Class:**\n    *   `__init__(self, target_dir, add_timestamp)`: Store config.\n    *   `_is_already_normalized(self, filename: str) -> bool`: Regex check (updated for optional timestamp).\n    *   `_scan_files(self) -> list[Path]`: Find files needing processing.\n    *   `_get_modification_timestamp(self, file_path: Path) -> str`: Format mtime.\n    *   `_parse_filename(self, filename: str) -> str | None`: Extract topic.\n    *   `_normalize_topic(self, topic: str) -> str`: Implement normalization rules.\n    *   `_clean_file_content(self, file_path: Path) -> tuple[int, int]`: Read content, use regex (`r\"!\[image\]\\(data:application/[^)]+\\)\"`) to remove images, use string replace for watermarks, count removals, overwrite file if changed, return `(images_removed, watermarks_removed)`. Handle file I/O errors.\n    *   `_rename_file(self, old_path: Path, new_filename: str)`: Handle rename and collisions.\n    *   `run(self)`: Orchestrate: Scan -> Loop -> Parse -> Normalize Topic -> Clean Content (on original path) -> Get Timestamp (if needed) -> Construct New Name -> Rename -> Accumulate & Log stats.\n4.  **Libraries:** `os`, `shutil`, `re`, `argparse`, `logging`, `datetime`, `pathlib`, `transliterate`.\n5.  **Error Handling:** Comprehensive checks.\n6.  **Dependencies:** `pip install transliterate`.\n\n**Verification:**\n\n*   Handles target dir/format? Yes.\n*   Optional timestamp? Yes (`--add-timestamp`).\n*   Normalization rules? Yes.\n*   Content cleaning (image/watermark)? Yes.\n*   File handling/collisions/idempotency? Yes.\n*   Logging & Stats? Yes.\n*   Execution/Scheduling? Yes.\n*   Extensibility considered? Yes.\n*   Dependencies noted? Yes.\n\nğŸ¨ğŸ¨ğŸ¨ **EXITING CREATIVE PHASE** ğŸ¨ğŸ¨ğŸ¨
